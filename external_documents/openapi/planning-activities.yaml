openapi: 3.1.0
info:
  title: Planning Activities API
  version: 0.1.0
  description: |
    REST-Schnittstelle für die Gantt-Aktivitäten der Order-Management-Anwendung.
    Alle Clients arbeiten gegen denselben Datenbestand. Validierungen für Orts-,
    Kapazitäts-, Arbeitszeit- und Qualifikationskonflikte werden serverseitig
    ausgeführt und können gezielt angefordert werden.
servers:
  - url: /api/v1
    description: Default Backend-URL (überschreibbar per API_CONFIG).
paths:
  /planning/stages/{stageId}:
    get:
      summary: Liefert Ressourcen, Aktivitäten und Zeitscheibe eines Planungsstadiums.
      operationId: getPlanningStage
      parameters:
        - $ref: '#/components/parameters/StageId'
      responses:
        '200':
          description: Stage Snapshot
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PlanningStageSnapshot'
  /planning/stages/{stageId}/resources:
    get:
      summary: Listet Ressourcen eines Planungsstadiums.
      operationId: listStageResources
      parameters:
        - $ref: '#/components/parameters/StageId'
      responses:
        '200':
          description: Liste der Ressourcen.
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Resource'
    put:
      summary: Batch-Synchronisation von Ressourcen (Create/Update/Delete).
      operationId: mutateStageResources
      parameters:
        - $ref: '#/components/parameters/StageId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ResourceMutationRequest'
      responses:
        '200':
          description: Ergebnis der Ressourcensynchronisation inkl. neuer Version.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ResourceMutationResponse'
  /planning/stages/{stageId}/activities:
    get:
      summary: Listet Aktivitäten gefiltert nach Zeitraum/Ressourcen.
      operationId: listStageActivities
      parameters:
        - $ref: '#/components/parameters/StageId'
        - name: from
          in: query
          schema:
            type: string
            format: date-time
          description: Startzeit (inklusive) zur Filterung.
        - name: to
          in: query
          schema:
            type: string
            format: date-time
          description: Endzeit (exklusive) zur Filterung.
        - name: resourceIds
          in: query
          schema:
            type: string
          description: Kommagetrennte Ressourcen-IDs.
      responses:
        '200':
          description: Gefilterte Aktivitätenliste.
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Activity'
    put:
      summary: Batch-Synchronisation von Aktivitäten (Create/Update/Delete).
      operationId: mutateStageActivities
      parameters:
        - $ref: '#/components/parameters/StageId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ActivityMutationRequest'
      responses:
        '200':
          description: Ergebnis der Synchronisation inkl. neuer Version.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ActivityMutationResponse'
  /planning/stages/{stageId}/activities:validate:
    post:
      summary: Startet serverseitige Validierung der angegebenen Aktivitäten.
      description: |
        Prüft Ortskonflikte (gleicher Standort, überlappende Zeiten),
        Kapazitätskonflikte (Kapazitätsgruppe überschritten),
        Arbeitszeitregeln (z. B. Ruhezeiten, maximale Dauer) sowie
        Qualifikationsanforderungen. Weitere Regeln lassen sich über `rule` =
        `custom` ergänzen.
      operationId: validateStageActivities
      parameters:
        - $ref: '#/components/parameters/StageId'
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ActivityValidationRequest'
      responses:
        '200':
          description: Liste der gefundenen Konflikte.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ActivityValidationResponse'
  /planning/stages/{stageId}/events:
    get:
      summary: Server-Sent-Events für Echtzeit-Sync einer Planungsstage.
      description: |
        Liefert ein `text/event-stream`, das Ressourcen-, Aktivitäten- und Timeline-Änderungen
        in Echtzeit überträgt. Jeder Datensatz ist ein JSON-Objekt vom Typ
        `PlanningStageRealtimeEvent`. Clients sollten pro Stage genau eine Verbindung öffnen.
      operationId: streamPlanningStageEvents
      parameters:
        - $ref: '#/components/parameters/StageId'
        - $ref: '#/components/parameters/UserId'
        - $ref: '#/components/parameters/ConnectionId'
      responses:
        '200':
          description: |
            Event-Stream. Jeder `data:`-Block enthält ein JSON-Objekt vom Typ
            `PlanningStageRealtimeEvent`. Der Server sollte Verbindungen offen halten
            und bei Inaktivität Heartbeat-Ereignisse senden.
          content:
            text/event-stream:
              schema:
                type: string
  /planning/master-data/personnel-service-pools:
    get:
      summary: Listet Personaldienstpools.
      operationId: listPersonnelServicePools
      responses:
        '200':
          description: Alle gespeicherten Personaldienstpools.
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/PersonnelServicePool'
    put:
      summary: Ersetzt den kompletten Satz an Personaldienstpools.
      operationId: savePersonnelServicePools
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PersonnelServicePoolListRequest'
      responses:
        '200':
          description: Persistierte Personaldienstpools.
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/PersonnelServicePool'
  /planning/master-data/personnel-pools:
    get:
      summary: Listet Personalpools.
      operationId: listPersonnelPools
      responses:
        '200':
          description: Alle gespeicherten Personalpools.
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/PersonnelPool'
    put:
      summary: Ersetzt den kompletten Satz an Personalpools.
      operationId: savePersonnelPools
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PersonnelPoolListRequest'
      responses:
        '200':
          description: Persistierte Personalpools.
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/PersonnelPool'
  /planning/master-data/vehicle-service-pools:
    get:
      summary: Listet Fahrzeugdienstpools.
      operationId: listVehicleServicePools
      responses:
        '200':
          description: Alle gespeicherten Fahrzeugdienstpools.
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/VehicleServicePool'
    put:
      summary: Ersetzt den kompletten Satz an Fahrzeugdienstpools.
      operationId: saveVehicleServicePools
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/VehicleServicePoolListRequest'
      responses:
        '200':
          description: Persistierte Fahrzeugdienstpools.
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/VehicleServicePool'
  /planning/master-data/vehicle-pools:
    get:
      summary: Listet Fahrzeugpools.
      operationId: listVehiclePools
      responses:
        '200':
          description: Alle gespeicherten Fahrzeugpools.
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/VehiclePool'
    put:
      summary: Ersetzt den kompletten Satz an Fahrzeugpools.
      operationId: saveVehiclePools
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/VehiclePoolListRequest'
      responses:
        '200':
          description: Persistierte Fahrzeugpools.
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/VehiclePool'
  /planning/master-data/vehicle-types:
    get:
      summary: Listet Fahrzeugtypen.
      operationId: listVehicleTypes
      responses:
        '200':
          description: Alle gespeicherten Fahrzeugtypen.
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/VehicleType'
    put:
      summary: Ersetzt den kompletten Satz an Fahrzeugtypen.
      operationId: saveVehicleTypes
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/VehicleTypeListRequest'
      responses:
        '200':
          description: Persistierte Fahrzeugtypen.
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/VehicleType'
  /planning/master-data/vehicle-compositions:
    get:
      summary: Listet Fahrzeugkompositionen.
      operationId: listVehicleCompositions
      responses:
        '200':
          description: Alle gespeicherten Fahrzeugkompositionen.
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/VehicleComposition'
    put:
      summary: Ersetzt den kompletten Satz an Fahrzeugkompositionen.
      operationId: saveVehicleCompositions
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/VehicleCompositionListRequest'
      responses:
        '200':
          description: Persistierte Fahrzeugkompositionen.
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/VehicleComposition'

components:
  parameters:
    StageId:
      name: stageId
      in: path
      required: true
      schema:
        type: string
        enum:
          - base
          - operations
          - dispatch
    UserId:
      name: userId
      in: query
      required: false
      description: Optional User-Identität, damit der SSE-Stream nur passende Events liefert.
      schema:
        type: string
    ConnectionId:
      name: connectionId
      in: query
      required: false
      description: Eindeutiger Verbindungs- bzw. Tab-Identifier, um Echo-Events zu unterdrücken.
      schema:
        type: string
  schemas:
    PlanningStageSnapshot:
      type: object
      properties:
        stageId:
          type: string
        resources:
          type: array
          items:
            $ref: '#/components/schemas/Resource'
        activities:
          type: array
          items:
            $ref: '#/components/schemas/Activity'
        timelineRange:
          $ref: '#/components/schemas/TimelineRange'
        version:
          type: string
          nullable: true
      required: [stageId, resources, activities, timelineRange]
    TimelineRange:
      type: object
      properties:
        start:
          type: string
          format: date-time
        end:
          type: string
          format: date-time
      required: [start, end]
    Resource:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        kind:
          type: string
          enum: [personnel-service, vehicle-service, personnel, vehicle]
        dailyServiceCapacity:
          type: integer
          minimum: 0
        attributes:
          type: object
          additionalProperties: true
      required: [id, name, kind]
    Activity:
      type: object
      properties:
        id:
          type: string
        resourceId:
          type: string
        participantResourceIds:
          type: array
          items:
            type: string
        clientId:
          type: string
          nullable: true
        title:
          type: string
        start:
          type: string
          format: date-time
        end:
          type: string
          format: date-time
          nullable: true
        type:
          type: string
        from:
          type: string
          nullable: true
        to:
          type: string
          nullable: true
        remark:
          type: string
          nullable: true
        serviceId:
          type: string
          nullable: true
        serviceTemplateId:
          type: string
          nullable: true
        serviceDate:
          type: string
          nullable: true
        serviceCategory:
          type: string
          nullable: true
        serviceRole:
          type: string
          nullable: true
        locationId:
          type: string
          nullable: true
        locationLabel:
          type: string
          nullable: true
        capacityGroupId:
          type: string
          nullable: true
        requiredQualifications:
          type: array
          items:
            type: string
        assignedQualifications:
          type: array
          items:
            type: string
        workRuleTags:
          type: array
          items:
            type: string
        attributes:
          type: object
          additionalProperties: true
          description: Freies Attribut-Bag für kundenspezifische Felder.
        meta:
          type: object
          additionalProperties: true
          description: Legacy-Feld für benutzerdefinierte Daten (bevorzugt `attributes` verwenden).
      required: [id, resourceId, title, start]
    PlanningStageRealtimeEvent:
      type: object
      description: Nachricht, die über den SSE-Stream `/planning/stages/{stageId}/events` gesendet wird.
      properties:
        stageId:
          type: string
          enum: [base, operations, dispatch]
        scope:
          type: string
          enum: [resources, activities, timeline]
        version:
          type: string
          nullable: true
        sourceClientId:
          type: string
          nullable: true
        sourceConnectionId:
          type: string
          nullable: true
        upserts:
          description: Ressourcen- oder Aktivitätsobjekte – abhängig von `scope`.
          type: array
          items:
            oneOf:
              - $ref: '#/components/schemas/Resource'
              - $ref: '#/components/schemas/Activity'
        deleteIds:
          type: array
          items:
            type: string
        timelineRange:
          $ref: '#/components/schemas/TimelineRange'
      required: [stageId, scope]
    ActivityMutationRequest:
      type: object
      properties:
        upserts:
          type: array
          items:
            $ref: '#/components/schemas/Activity'
        deleteIds:
          type: array
          items:
            type: string
        clientRequestId:
          type: string
      additionalProperties: false
    ActivityMutationResponse:
      type: object
      properties:
        appliedUpserts:
          type: array
          items:
            type: string
        deletedIds:
          type: array
          items:
            type: string
        version:
          type: string
          nullable: true
      required: [appliedUpserts, deletedIds]
    ResourceMutationRequest:
      type: object
      properties:
        upserts:
          type: array
          items:
            $ref: '#/components/schemas/Resource'
        deleteIds:
          type: array
          items:
            type: string
        clientRequestId:
          type: string
      additionalProperties: false
    ResourceMutationResponse:
      type: object
      properties:
        appliedUpserts:
          type: array
          items:
            type: string
        deletedIds:
          type: array
          items:
            type: string
        version:
          type: string
          nullable: true
      required: [appliedUpserts, deletedIds]
    ActivityValidationRequest:
      type: object
      properties:
        activityIds:
          type: array
          items:
            type: string
        windowStart:
          type: string
          format: date-time
        windowEnd:
          type: string
          format: date-time
        resourceIds:
          type: array
          items:
            type: string
        clientRequestId:
          type: string
      additionalProperties: false
    ActivityValidationResponse:
      type: object
      properties:
        generatedAt:
          type: string
          format: date-time
        issues:
          type: array
          items:
            $ref: '#/components/schemas/ActivityValidationIssue'
      required: [generatedAt, issues]
    ActivityValidationIssue:
      type: object
      properties:
        id:
          type: string
        rule:
          type: string
          enum: [location-conflict, capacity-conflict, working-time, qualification, custom]
        severity:
          type: string
          enum: [info, warning, error]
        message:
          type: string
        activityIds:
          type: array
          items:
            type: string
        meta:
          type: object
          additionalProperties: true
      required: [id, rule, severity, message, activityIds]
    PersonnelServicePool:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        description:
          type: string
          nullable: true
        serviceIds:
          type: array
          items:
            type: string
        shiftCoordinator:
          type: string
          nullable: true
        contactEmail:
          type: string
          format: email
          nullable: true
      required: [id, name, serviceIds]
        attributes:
          type: object
          additionalProperties: true
    PersonnelServicePoolListRequest:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/PersonnelServicePool'
      required: [items]
    PersonnelPool:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        description:
          type: string
          nullable: true
        personnelIds:
          type: array
          items:
            type: string
        locationCode:
          type: string
          nullable: true
      required: [id, name, personnelIds]
        attributes:
          type: object
          additionalProperties: true
    PersonnelPoolListRequest:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/PersonnelPool'
      required: [items]
    VehicleServicePool:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        description:
          type: string
          nullable: true
        serviceIds:
          type: array
          items:
            type: string
        dispatcher:
          type: string
          nullable: true
      required: [id, name, serviceIds]
        attributes:
          type: object
          additionalProperties: true
    VehicleServicePoolListRequest:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/VehicleServicePool'
      required: [items]
    VehiclePool:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        description:
          type: string
          nullable: true
        vehicleIds:
          type: array
          items:
            type: string
        depotManager:
          type: string
          nullable: true
      required: [id, name, vehicleIds]
        attributes:
          type: object
          additionalProperties: true
    VehiclePoolListRequest:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/VehiclePool'
      required: [items]
    VehicleType:
      type: object
      properties:
        id:
          type: string
        label:
          type: string
        category:
          type: string
          nullable: true
        capacity:
          type: integer
          nullable: true
        maxSpeed:
          type: integer
          nullable: true
        maintenanceIntervalDays:
          type: integer
          nullable: true
        energyType:
          type: string
          nullable: true
        manufacturer:
          type: string
          nullable: true
        trainTypeCode:
          type: string
          nullable: true
        lengthMeters:
          type: number
          format: float
          nullable: true
        weightTons:
          type: number
          format: float
          nullable: true
        brakeType:
          type: string
          nullable: true
        brakePercentage:
          type: integer
          nullable: true
        tiltingCapability:
          type: string
          enum: [none, passive, active]
          nullable: true
        powerSupplySystems:
          type: array
          items:
            type: string
        trainProtectionSystems:
          type: array
          items:
            type: string
        etcsLevel:
          type: string
          nullable: true
        gaugeProfile:
          type: string
          nullable: true
        maxAxleLoad:
          type: number
          format: float
          nullable: true
        noiseCategory:
          type: string
          nullable: true
        remarks:
          type: string
          nullable: true
      required: [id, label]
        attributes:
          type: object
          additionalProperties: true
    VehicleTypeListRequest:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/VehicleType'
      required: [items]
    VehicleCompositionEntry:
      type: object
      properties:
        typeId:
          type: string
        quantity:
          type: integer
      required: [typeId, quantity]
    VehicleComposition:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        entries:
          type: array
          items:
            $ref: '#/components/schemas/VehicleCompositionEntry'
        turnaroundBuffer:
          type: string
          nullable: true
        remark:
          type: string
          nullable: true
      required: [id, name, entries]
        attributes:
          type: object
          additionalProperties: true
    VehicleCompositionListRequest:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/VehicleComposition'
      required: [items]
