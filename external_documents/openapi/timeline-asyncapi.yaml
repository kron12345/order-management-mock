asyncapi: 3.0.0
info:
  title: Planning Timeline WebSocket API
  version: 0.1.0
  description: |
    WebSocket-Schnittstelle für Live- und Template-Timelines.
    Namespaces:
      - /timeline (Live-Planning)
      - /templates (Template-Timelines, erfordern templateId im Kontext)
defaultContentType: application/json
servers:
  live:
    host: localhost:3000/timeline
    protocol: ws
    description: Live-Planning WS (Namespace /timeline)
  templates:
    host: localhost:3000/templates
    protocol: ws
    description: Template-Timelines WS (Namespace /templates)
channels:
  live-events:
    address: /timeline
    messages:
      viewportChanged:
        summary: Viewport aktualisieren
        payload:
          $ref: '#/components/schemas/ViewportChanged'
      activityUpdateRequest:
        summary: Aktivitäts-Update anfordern
        payload:
          $ref: '#/components/schemas/ActivityUpdateRequest'
      activityUpdated:
        summary: Aktivitäts-Update Broadcast
        payload:
          $ref: '#/components/schemas/ActivityUpdated'
      serviceUpdated:
        summary: Dienst/Abwesenheit-Update Broadcast
        payload:
          $ref: '#/components/schemas/ServiceUpdated'
      validationResult:
        summary: Validierungsergebnis
        payload:
          $ref: '#/components/schemas/ValidationResult'
  template-events:
    address: /templates
    messages:
      viewportChanged:
        summary: Viewport aktualisieren (Template)
        payload:
          allOf:
            - $ref: '#/components/schemas/ViewportChanged'
            - type: object
              properties:
                templateId:
                  type: string
              required: [templateId]
      activityUpdateRequest:
        summary: Aktivitäts-Update anfordern (Template)
        payload:
          allOf:
            - $ref: '#/components/schemas/ActivityUpdateRequest'
            - type: object
              properties:
                templateId:
                  type: string
              required: [templateId]
      activityUpdated:
        summary: Aktivitäts-Update Broadcast (Template)
        payload:
          $ref: '#/components/schemas/ActivityUpdated'
      serviceUpdated:
        summary: Dienst/Abwesenheit-Update Broadcast (Template)
        payload:
          $ref: '#/components/schemas/ServiceUpdated'
      validationResult:
        summary: Validierungsergebnis (Template)
        payload:
          $ref: '#/components/schemas/ValidationResult'
components:
  schemas:
    ViewportChanged:
      type: object
      properties:
        type:
          const: VIEWPORT_CHANGED
        payload:
          type: object
          properties:
            from: { type: string, format: date-time }
            to: { type: string, format: date-time }
            lod: { type: string, enum: [activity, service] }
            stage: { type: string, enum: [base, operations] }
          required: [from, to]
      required: [type, payload]
    ActivityUpdateRequest:
      type: object
      properties:
        type:
          const: ACTIVITY_UPDATE_REQUEST
        payload:
          type: object
          properties:
            requestId: { type: string }
            activityId: { type: string }
            newStart: { type: string, format: date-time }
            newEnd: { type: string, format: date-time, nullable: true }
            stage: { type: string, enum: [base, operations] }
          required: [requestId, activityId, newStart]
      required: [type, payload]
    ActivityUpdated:
      type: object
      properties:
        type:
          const: ACTIVITY_UPDATED
        payload:
          $ref: './planning/components/schemas.yaml#/components/schemas/TimelineActivity'
      required: [type, payload]
    ServiceUpdated:
      type: object
      properties:
        type:
          enum: [SERVICE_UPDATED, ABSENCE_UPDATED]
        payload:
          $ref: './planning/components/schemas.yaml#/components/schemas/TimelineService'
      required: [type, payload]
    ValidationResult:
      type: object
      properties:
        type:
          const: ACTIVITY_UPDATE_VALIDATION_RESULT
        payload:
          type: object
          properties:
            requestId: { type: string }
            activityId: { type: string }
            status: { type: string, enum: [OK, ERROR] }
            errors:
              type: array
              items:
                type: object
                properties:
                  code: { type: string }
                  message: { type: string }
                required: [code, message]
          required: [requestId, activityId, status]
      required: [type, payload]
