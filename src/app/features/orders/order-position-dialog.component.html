<h2 mat-dialog-title>Auftragsposition hinzufügen</h2>

<mat-dialog-content>
  <div class="mode-toggle">
    <mat-button-toggle-group [formControl]="modeControl" appearance="legacy">
      <mat-button-toggle value="service">Leistung</mat-button-toggle>
      <mat-button-toggle value="plan">Fahrplan (Serie)</mat-button-toggle>
      <mat-button-toggle value="manualPlan">Fahrplan (manuell)</mat-button-toggle>
      <mat-button-toggle value="import">Fahrplan (Import)</mat-button-toggle>
    </mat-button-toggle-group>
  </div>

  <div class="section" *ngIf="mode() === 'service'">
    <form [formGroup]="serviceForm" class="form">
      <app-order-item-general-fields
        [form]="serviceForm"
        [labels]="serviceGeneralLabels"
        [hints]="{ name: 'Ohne Eingabe wird der Leistungstyp als Name verwendet.', deviation: 'z. B. +3 min' }"
        [placeholders]="{ name: 'Leistung · Nachtpflege', deviation: 'z. B. +3 min' }"
        [descriptions]="serviceGeneralDescriptions"
        [responsibleControl]="null"
      ></app-order-item-general-fields>

      <app-order-item-service-fields
        [form]="serviceForm"
        [config]="serviceFieldsConfig"
        [trafficPeriods]="trafficPeriods()"
        [placeholders]="{ serviceType: 'z. B. Werkstattaufenthalt', from: 'z. B. Basel SBB', to: 'z. B. Zürich HB' }"
        [descriptions]="serviceFieldDescriptions"
        [timeInputType]="'time'"
      ></app-order-item-service-fields>

      <button
        mat-stroked-button
        type="button"
        class="inline-button"
        (click)="openTrafficPeriodEditor('service')"
      >
        <mat-icon>event</mat-icon>
        Verkehrsperiode erstellen
      </button>
    </form>
  </div>

  <div class="section" *ngIf="mode() === 'plan'">
    <div class="inline-actions">
      <button mat-stroked-button type="button" (click)="openTemplateCreateDialog()">
        <mat-icon>schema</mat-icon>
        Vorlage erstellen
      </button>
      <button
        mat-stroked-button
        type="button"
        (click)="openTrafficPeriodEditor('plan')"
      >
        <mat-icon>event</mat-icon>
        Verkehrsperiode erstellen
      </button>
    </div>
    <form [formGroup]="planForm" class="form">
      <mat-form-field appearance="outline">
        <mat-label>Vorlage</mat-label>
        <mat-select formControlName="templateId">
          @for (template of templates(); track template.id) {
            <mat-option [value]="template.id">{{ template.title }}</mat-option>
          }
        </mat-select>
        <button
          mat-icon-button
          matSuffix
          type="button"
          class="help-icon"
          [matTooltip]="planFieldDescriptions.templateId"
          aria-label="Vorlage Hilfe"
        >
          <mat-icon>help_outline</mat-icon>
        </button>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Verkehrsperiode</mat-label>
        <mat-select formControlName="trafficPeriodId">
          @for (period of trafficPeriods(); track period.id) {
            <mat-option [value]="period.id">{{ period.name }}</mat-option>
          }
        </mat-select>
        <button
          mat-icon-button
          matSuffix
          type="button"
          class="help-icon"
          [matTooltip]="planFieldDescriptions.trafficPeriodId"
          aria-label="Verkehrsperiode Hilfe"
        >
          <mat-icon>help_outline</mat-icon>
        </button>
      </mat-form-field>

      <div class="grid">
        <mat-form-field appearance="outline">
          <mat-label>Erste Abfahrt</mat-label>
          <input matInput type="time" formControlName="startTime" />
          <button
            mat-icon-button
            matSuffix
            type="button"
            class="help-icon"
            [matTooltip]="planFieldDescriptions.startTime"
            aria-label="Erste Abfahrt Hilfe"
          >
            <mat-icon>help_outline</mat-icon>
          </button>
        </mat-form-field>
        <mat-form-field appearance="outline">
          <mat-label>Letzte Abfahrt</mat-label>
          <input matInput type="time" formControlName="endTime" />
          <button
            mat-icon-button
            matSuffix
            type="button"
            class="help-icon"
            [matTooltip]="planFieldDescriptions.endTime"
            aria-label="Letzte Abfahrt Hilfe"
          >
            <mat-icon>help_outline</mat-icon>
          </button>
        </mat-form-field>
        <mat-form-field appearance="outline">
          <mat-label>Takt (Minuten)</mat-label>
          <input matInput type="number" formControlName="intervalMinutes" min="1" />
          <mat-hint>Abstand zwischen den Zügen, z. B. 30.</mat-hint>
          <button
            mat-icon-button
            matSuffix
            type="button"
            class="help-icon"
            [matTooltip]="planFieldDescriptions.intervalMinutes"
            aria-label="Takt Hilfe"
          >
            <mat-icon>help_outline</mat-icon>
          </button>
        </mat-form-field>
      </div>

      <div class="grid">
        <mat-form-field appearance="outline">
          <mat-label>Namenspräfix</mat-label>
          <input matInput formControlName="namePrefix" placeholder="z. B. S3 Basel" />
          <button
            mat-icon-button
            matSuffix
            type="button"
            class="help-icon"
            [matTooltip]="planFieldDescriptions.namePrefix"
            aria-label="Namenspräfix Hilfe"
          >
            <mat-icon>help_outline</mat-icon>
          </button>
        </mat-form-field>
        <mat-form-field appearance="outline">
          <mat-label>Verantwortlich</mat-label>
          <input matInput formControlName="responsible" />
          <button
            mat-icon-button
            matSuffix
            type="button"
            class="help-icon"
            [matTooltip]="planFieldDescriptions.responsible"
            aria-label="Verantwortlich Hilfe"
          >
            <mat-icon>help_outline</mat-icon>
          </button>
        </mat-form-field>
      </div>

      <div class="grid">
        <mat-form-field appearance="outline">
          <mat-label>Zugnummer (OTN)</mat-label>
          <input matInput type="number" formControlName="otn" placeholder="z. B. 2400" />
          <button
            mat-icon-button
            matSuffix
            type="button"
            class="help-icon"
            [matTooltip]="planFieldDescriptions.otn"
            aria-label="OTN Hilfe"
          >
            <mat-icon>help_outline</mat-icon>
          </button>
        </mat-form-field>
        <mat-form-field appearance="outline">
          <mat-label>OTN-Intervall</mat-label>
          <input matInput type="number" min="1" formControlName="otnInterval" />
          <button
            mat-icon-button
            matSuffix
            type="button"
            class="help-icon"
            [matTooltip]="planFieldDescriptions.otnInterval"
            aria-label="OTN Intervall Hilfe"
          >
            <mat-icon>help_outline</mat-icon>
          </button>
        </mat-form-field>
      </div>
    </form>
  </div>

  <div class="section" *ngIf="mode() === 'manualPlan'">
    <div class="inline-actions">
      <button mat-stroked-button type="button" (click)="openManualPlanAssembly()">
        <mat-icon>alt_route</mat-icon>
        Fahrplan zusammenstellen
      </button>
      <p class="hint">
        Stelle den Fahrplan direkt zusammen. Der Fahrtag bestimmt nur das Datum, alle Zeiten definierst du im Editor.
      </p>
    </div>

    @if (manualTemplate(); as stops) {
      @if (stops.length) {
        <mat-card class="template-summary">
          <div class="template-summary__header">
            <div>
              <strong>{{ manualPlanForm.controls.name.value || 'Manueller Fahrplan' }}</strong>
              <span class="template-summary__train">
                Zug {{ manualPlanForm.controls.trainNumber.value || '—' }}
              </span>
            </div>
            <div class="template-summary__actions">
              <span class="template-summary__meta">
                {{ stops.length }} Halte ·
                {{ stops[0].locationName || '—' }} – {{ stops[stops.length - 1].locationName || '—' }}
              </span>
              @if (manualPlanForm.controls.trafficPeriodId.value) {
                <span class="template-summary__meta">
                  Verkehrsperiode:
                  {{
                    trafficPeriodName(manualPlanForm.controls.trafficPeriodId.value)
                      || 'unbekannt'
                  }}
                </span>
              }
              <button
                mat-icon-button
                type="button"
                (click)="openManualPlanAssembly()"
                aria-label="Fahrplan bearbeiten"
              >
                <mat-icon>edit</mat-icon>
              </button>
              <button
                mat-icon-button
                type="button"
                (click)="clearManualTemplate()"
                aria-label="Fahrplan entfernen"
              >
                <mat-icon>close</mat-icon>
              </button>
            </div>
          </div>
          <div class="template-summary__times">
            <span>
              <strong>Start</strong>
              {{ stops[0].departureTime || stops[0].arrivalTime || '--:--' }}
            </span>
            <mat-icon>arrow_forward</mat-icon>
            <span>
              <strong>Ende</strong>
              {{
                stops[stops.length - 1].arrivalTime ||
                  stops[stops.length - 1].departureTime ||
                  '--:--'
              }}
            </span>
          </div>
        </mat-card>
      } @else {
        <p class="hint">Definiere Halte und Zeiten, um einen einmaligen Fahrplan zu erzeugen.</p>
      }
    } @else {
      <p class="hint">Definiere Halte und Zeiten, um einen einmaligen Fahrplan zu erzeugen.</p>
    }

    <form [formGroup]="manualPlanForm" class="form">
      <div class="grid">
        <mat-form-field appearance="outline">
          <mat-label>Fahrtag</mat-label>
          <input
            matInput
            type="date"
            formControlName="departureDate"
            [disabled]="!!manualPlanForm.controls.trafficPeriodId.value"
          />
          <button
            mat-icon-button
            matSuffix
            type="button"
            class="help-icon"
            [matTooltip]="manualFieldDescriptions.departureDate"
            aria-label="Fahrtag Hilfe"
          >
            <mat-icon>help_outline</mat-icon>
          </button>
        </mat-form-field>
        <mat-form-field appearance="outline">
          <mat-label>Verkehrsperiode</mat-label>
          <mat-select
            formControlName="trafficPeriodId"
            [disabled]="!!manualPlanForm.controls.departureDate.value"
          >
            <mat-option value="">Keine Auswahl</mat-option>
            @for (period of trafficPeriods(); track period.id) {
              <mat-option [value]="period.id">{{ period.name }}</mat-option>
            }
          </mat-select>
          <button
            mat-icon-button
            matSuffix
            type="button"
            class="help-icon"
            [matTooltip]="manualFieldDescriptions.trafficPeriodId"
            aria-label="Verkehrsperiode Hilfe"
          >
            <mat-icon>help_outline</mat-icon>
          </button>
        </mat-form-field>
        <mat-form-field appearance="outline">
          <mat-label>Zugnummer (OTN)</mat-label>
          <input matInput formControlName="trainNumber" />
          <button
            mat-icon-button
            matSuffix
            type="button"
            class="help-icon"
            [matTooltip]="manualFieldDescriptions.trainNumber"
            aria-label="Zugnummer Hilfe"
          >
            <mat-icon>help_outline</mat-icon>
          </button>
        </mat-form-field>
      </div>
      <p class="field-hint">
        Wähle entweder einen Fahrtag oder eine Verkehrsperiode – beides gleichzeitig ist nicht möglich.
      </p>
      <app-order-item-general-fields
        [form]="manualPlanForm"
        [labels]="manualGeneralLabels"
        [placeholders]="{ name: 'z. B. Sonderzug 4711' }"
        [descriptions]="manualGeneralDescriptions"
      ></app-order-item-general-fields>
    </form>
  </div>

  <div class="section" *ngIf="mode() === 'import'">
    <div class="inline-actions">
      <label class="file-input">
        <input type="file" accept=".xml,.railml,.railml.xml" (change)="onRailMlFileSelected($event)" />
        <span>
          <mat-icon>upload_file</mat-icon>
          RailML-Datei auswählen
        </span>
      </label>
      <button mat-stroked-button type="button" (click)="clearImportedData()">
        <mat-icon>delete_sweep</mat-icon>
        Auswahl zurücksetzen
      </button>
    </div>

    @if (importError()) {
      <p class="error">{{ importError() }}</p>
    }

    @if (importedTrains().length) {
      <form [formGroup]="importOptionsForm" class="form form--compact">
        <div class="grid">
          <mat-form-field appearance="outline">
            <mat-label>Verkehrsperiode</mat-label>
            <mat-select formControlName="trafficPeriodId">
              @for (period of trafficPeriods(); track period.id) {
                <mat-option [value]="period.id">{{ period.name }}</mat-option>
              }
            </mat-select>
            <button
              mat-icon-button
              matSuffix
              type="button"
              class="help-icon"
              [matTooltip]="importOptionsDescriptions.trafficPeriodId"
              aria-label="Verkehrsperiode Hilfe"
            >
              <mat-icon>help_outline</mat-icon>
            </button>
          </mat-form-field>
          <mat-form-field appearance="outline">
            <mat-label>Namenspräfix</mat-label>
            <input matInput formControlName="namePrefix" placeholder="z. B. RailML Import" />
            <button
              mat-icon-button
              matSuffix
              type="button"
              class="help-icon"
              [matTooltip]="importOptionsDescriptions.namePrefix"
              aria-label="Namenspräfix Hilfe"
            >
              <mat-icon>help_outline</mat-icon>
            </button>
          </mat-form-field>
          <mat-form-field appearance="outline">
            <mat-label>Verantwortlich</mat-label>
            <input matInput formControlName="responsible" />
            <button
              mat-icon-button
              matSuffix
              type="button"
              class="help-icon"
              [matTooltip]="importOptionsDescriptions.responsible"
              aria-label="Verantwortlich Hilfe"
            >
              <mat-icon>help_outline</mat-icon>
            </button>
          </mat-form-field>
        </div>
      </form>

      <form [formGroup]="importFilters" class="import-filters">
        <mat-form-field appearance="outline">
          <mat-label>Suche</mat-label>
          <input matInput formControlName="search" placeholder="Train-ID oder Name" />
          <button
            mat-icon-button
            matSuffix
            type="button"
            class="help-icon"
            [matTooltip]="importFilterDescriptions.search"
            aria-label="Suche Hilfe"
          >
            <mat-icon>help_outline</mat-icon>
          </button>
        </mat-form-field>
        <mat-form-field appearance="outline">
          <mat-label>Start</mat-label>
          <input matInput formControlName="start" placeholder="z. B. Basel" />
          <button
            mat-icon-button
            matSuffix
            type="button"
            class="help-icon"
            [matTooltip]="importFilterDescriptions.start"
            aria-label="Start-Filter Hilfe"
          >
            <mat-icon>help_outline</mat-icon>
          </button>
        </mat-form-field>
        <mat-form-field appearance="outline">
          <mat-label>Ziel</mat-label>
          <input matInput formControlName="end" placeholder="z. B. Zürich" />
          <button
            mat-icon-button
            matSuffix
            type="button"
            class="help-icon"
            [matTooltip]="importFilterDescriptions.end"
            aria-label="Ziel-Filter Hilfe"
          >
            <mat-icon>help_outline</mat-icon>
          </button>
        </mat-form-field>
        <button mat-stroked-button type="button" (click)="onImportFiltersReset()">
          <mat-icon>clear_all</mat-icon>
          Filter zurücksetzen
        </button>
      </form>

      <div class="import-results">
        <div class="import-results__actions">
          <div>
            {{ filteredTrains().length }} Züge · {{ selectedTrainIds().size }} ausgewählt
          </div>
          <div class="import-results__buttons">
            <button mat-button type="button" (click)="selectAllFiltered(true)">Alle auswählen</button>
            <button mat-button type="button" (click)="selectAllFiltered(false)">Auswahl aufheben</button>
          </div>
        </div>

        <mat-selection-list [multiple]="true">
          @for (train of filteredTrains(); track trackByTrainId($index, train)) {
            <mat-list-option
              [selected]="isTrainSelected(train.id)"
              (selectedChange)="toggleTrainSelection(train.id, $event)"
              class="import-train-option"
            >
              <div class="import-train">
                <div class="import-train__header">
                  <div class="import-train__title-block">
                    <div class="import-train__title">
                      <strong>{{ train.name }}</strong>
                      @if (train.variantLabel) {
                        <span class="import-train__variant-chip">
                          <mat-icon>tune</mat-icon>
                          {{ train.variantLabel }}
                        </span>
                      }
                    </div>
                    <div class="import-train__chips">
                      <mat-chip-set aria-label="Zugdaten">
                        <mat-chip disableRipple>
                          <mat-icon>confirmation_number</mat-icon>
                          {{ train.number }}
                        </mat-chip>
                        <mat-chip disableRipple>
                          <mat-icon>category</mat-icon>
                          {{ train.category || 'ohne Kategorie' }}
                        </mat-chip>
                        @if (train.trafficPeriodName) {
                          <mat-chip disableRipple>
                            <mat-icon>calendar_month</mat-icon>
                            {{ train.trafficPeriodName }}
                          </mat-chip>
                        }
                        @if (train.operatingPeriodRef) {
                          <mat-chip disableRipple>
                            <mat-icon>link</mat-icon>
                            {{ train.operatingPeriodRef }}
                          </mat-chip>
                        }
                      </mat-chip-set>
                    </div>
                  </div>
                  <div class="import-train__actions">
                    <span class="import-train__stops-count">
                      {{ train.stops.length }} Halte
                    </span>
                    <button
                      mat-icon-button
                      type="button"
                      (click)="toggleTrainExpansion(train.id, $event)"
                      [attr.aria-label]="
                        isTrainExpanded(train.id)
                          ? 'Details einklappen'
                          : 'Details aufklappen'
                      "
                    >
                      <mat-icon>
                        {{ isTrainExpanded(train.id) ? 'expand_less' : 'expand_more' }}
                      </mat-icon>
                    </button>
                  </div>
                </div>
                <div class="import-train__summary">
                  <div class="import-train__timeline">
                    <div class="import-train__timeline-point">
                      <span class="import-train__time">{{ train.departureTime || '--:--' }}</span>
                      <small>{{ train.start || '—' }}</small>
                    </div>
                    <div class="import-train__timeline-line">
                      <mat-icon>trending_flat</mat-icon>
                    </div>
                    <div class="import-train__timeline-point import-train__timeline-point--end">
                      <span class="import-train__time">{{ train.arrivalTime || '--:--' }}</span>
                      <small>{{ train.end || '—' }}</small>
                    </div>
                  </div>
                  <div class="import-train__badges">
                    @if (train.variantOf) {
                      <span class="import-train__badge">
                        Variante von {{ train.variantOf }}
                      </span>
                    }
                    @if (train.trainPartId) {
                      <span class="import-train__badge">
                        TrainPart: {{ train.trainPartId }}
                      </span>
                    }
                  </div>
                </div>
                @if (isTrainExpanded(train.id)) {
                  <div class="import-train__details">
                    <div class="import-train__details-header">
                      Halteübersicht
                    </div>
                    <div class="import-train__stops">
                      @for (stop of train.stops; track $index; let idx = $index) {
                        <div class="import-train__stop-row">
                          <div class="import-train__stop-seq">#{{ idx + 1 }}</div>
                          <div class="import-train__stop-location">
                            <strong>{{ stop.locationName || stop.locationCode }}</strong>
                            <small>{{ stop.locationCode }}</small>
                          </div>
                          <div class="import-train__stop-times">
                            <div>
                              <span>Ankunft</span>
                              <strong>{{ stopTimeLabel(stop, 'arrival') }}</strong>
                            </div>
                            <div>
                              <span>Abfahrt</span>
                              <strong>{{ stopTimeLabel(stop, 'departure') }}</strong>
                            </div>
                          </div>
                          <div class="import-train__stop-meta">
                            @if (stop.activities.length) {
                              <span>{{ stop.activities.join(', ') }}</span>
                            }
                          </div>
                        </div>
                      }
                    </div>
                  </div>
                }
              </div>
            </mat-list-option>
          }
        </mat-selection-list>
      </div>
    } @else if (!importError()) {
      <p class="hint">
        Wähle eine RailML-Datei, um Züge zu importieren.
      </p>
    }
  </div>

  @if (errorMessage()) {
    <p class="error">{{ errorMessage() }}</p>
  }
</mat-dialog-content>

<mat-dialog-actions align="end">
  <button mat-button (click)="cancel()">Abbrechen</button>
  <button mat-flat-button color="primary" (click)="save()">Speichern</button>
</mat-dialog-actions>
