<section class="activity-catalog">
  <header class="activity-catalog__header">
    <div>
      <p class="activity-catalog__eyebrow">Leistungseditor</p>
      <h2>Activity Keys & Templates</h2>
      <p class="activity-catalog__lead">
        Definiere Activity Keys mit Typ, Laufzeit und frei kombinierbaren Attributen. Baue Templates
        mit vordefinierten Attribut-Sets und verknüpfe sie mit deinen Keys.
      </p>
    </div>
    <div class="activity-catalog__badges">
      <span class="pill">{{ activities().length }} Activities</span>
      <span class="pill pill--ghost">{{ templates().length }} Templates</span>
    </div>
  </header>

  <div class="activity-catalog__grid">
    <mat-card class="panel">
      <div class="panel__header">
        <div>
          <p class="panel__eyebrow">Vorlagen</p>
          <h3>Templates</h3>
        </div>
        <button mat-flat-button color="primary" type="button" (click)="saveTemplate()">
          <mat-icon fontIcon="save"></mat-icon>
          {{ templateEditId() ? 'Template speichern' : 'Template anlegen' }}
        </button>
      </div>

      <form class="form" [formGroup]="templateForm">
        <div class="form__row">
          <mat-form-field appearance="outline">
            <mat-label>Name</mat-label>
            <input matInput formControlName="label" />
          </mat-form-field>
          <mat-form-field appearance="outline">
            <mat-label>Technischer Key</mat-label>
            <input matInput formControlName="id" />
          </mat-form-field>
        </div>

        <div class="form__row">
          <mat-form-field appearance="outline">
            <mat-label>Activity-Type (optional)</mat-label>
            <input matInput formControlName="activityType" />
          </mat-form-field>
          <mat-form-field appearance="outline">
            <mat-label>Default-Dauer (min)</mat-label>
            <input matInput type="number" formControlName="defaultDurationMinutes" />
          </mat-form-field>
        </div>

        <mat-form-field appearance="outline" class="form__row">
          <mat-label>Beschreibung</mat-label>
          <textarea matInput rows="2" formControlName="description"></textarea>
        </mat-form-field>

        <div class="attributes">
          <div class="attributes__header">
            <span>Attribute</span>
            <mat-form-field appearance="outline" class="attributes__preset">
              <mat-label>Preset hinzufügen</mat-label>
              <mat-select (selectionChange)="addTemplateAttributeFromPreset($event.value)" [value]="null">
                <mat-option [value]="null">Ohne</mat-option>
                @for (preset of attributePresets(); track preset.key) {
                  <mat-option [value]="preset.key">{{ preset.key }}</mat-option>
                }
              </mat-select>
            </mat-form-field>
            <button mat-stroked-button type="button" (click)="addTemplateAttribute()">
              <mat-icon fontIcon="add"></mat-icon>
              Attribut
            </button>
          </div>
          <div class="attributes__list" formArrayName="attributes">
            @for (attr of templateAttributes.controls; track attr; let i = $index) {
              <div class="attributes__row" [formGroupName]="i">
                <mat-form-field appearance="outline">
                  <mat-label>Key</mat-label>
                  <input matInput formControlName="key" />
                </mat-form-field>
                <button mat-icon-button type="button" (click)="removeTemplateAttribute(i)" matTooltip="Entfernen">
                  <mat-icon fontIcon="close"></mat-icon>
                </button>
                <div class="attributes__meta" formArrayName="meta">
                  <div class="attributes__meta-row" *ngFor="let meta of templateMetaControls(attr); let m = index" [formGroupName]="m">
                    <mat-form-field appearance="outline">
                      <mat-label>Meta-Key</mat-label>
                      <input matInput formControlName="key" />
                    </mat-form-field>
                    <mat-form-field appearance="outline">
                      <mat-label>Meta-Wert</mat-label>
                      <input matInput formControlName="value" />
                    </mat-form-field>
                    <button mat-icon-button type="button" (click)="removeTemplateMeta(attr, m)" matTooltip="Meta entfernen">
                      <mat-icon fontIcon="close"></mat-icon>
                    </button>
                  </div>
                  <button mat-stroked-button type="button" (click)="addTemplateMeta(attr)">
                    <mat-icon fontIcon="add"></mat-icon>
                    Meta
                  </button>
                </div>
              </div>
              }
            @if (templateAttributes.length === 0) {
              <p class="attributes__placeholder">Keine Attribute – füge beliebige Key/Value-Paare hinzu.</p>
            }
          </div>
        </div>

        <div class="form__actions">
          <button mat-button type="button" (click)="cancelTemplateEdit()">
            Abbrechen
          </button>
          <button mat-flat-button color="primary" type="button" (click)="saveTemplate()">
            {{ templateEditId() ? 'Speichern' : 'Anlegen' }}
          </button>
        </div>
      </form>

      <mat-divider class="panel__divider" />

      <div class="cards">
        @if (templates().length === 0) {
          <p class="cards__empty">Noch keine Templates vorhanden.</p>
        } @else {
          @for (template of templates(); track template.id) {
            <mat-card class="card">
              <div class="card__heading">
                <div>
                  <p class="card__eyebrow">Template</p>
                  <h4>{{ template.label }}</h4>
                </div>
                <div class="card__actions">
                  <button mat-icon-button matTooltip="Bearbeiten" (click)="startTemplateEdit(template)">
                    <mat-icon fontIcon="edit"></mat-icon>
                  </button>
                  <button mat-icon-button matTooltip="Löschen" (click)="removeTemplate(template)">
                    <mat-icon fontIcon="delete"></mat-icon>
                  </button>
                </div>
              </div>
              <p class="card__description" *ngIf="template.description">{{ template.description }}</p>
              <div class="card__meta">
                <span class="chip" *ngIf="template.activityType">Typ: {{ template.activityType }}</span>
                <span class="chip" *ngIf="template.defaultDurationMinutes">
                  Dauer: {{ template.defaultDurationMinutes }} min
                </span>
                <span class="chip chip--ghost">{{ template.id }}</span>
              </div>
              <div class="card__attributes" *ngIf="template.attributes.length">
                <mat-chip-listbox>
                  @for (attr of template.attributes; track attr.key) {
                  <mat-chip>
                    <strong>{{ attr.key }}</strong>
                    <span *ngIf="attr.meta?.['value'] as val">Value: {{ val }}</span>
                    <span *ngIf="attr.meta && !attr.meta?.['value']">{{ attr.meta | json }}</span>
                  </mat-chip>
                }
              </mat-chip-listbox>
            </div>
          </mat-card>
        }
        }
      </div>
    </mat-card>

    <mat-card class="panel panel--accent">
      <div class="panel__header">
        <div>
          <p class="panel__eyebrow">Activities</p>
          <h3>Activity Keys</h3>
        </div>
        <button mat-flat-button color="primary" type="button" (click)="saveActivity()">
          <mat-icon fontIcon="save"></mat-icon>
          {{ activityEditId() ? 'Activity speichern' : 'Activity anlegen' }}
        </button>
      </div>

      <form class="form" [formGroup]="activityForm">
        <div class="form__row">
          <mat-form-field appearance="outline">
            <mat-label>Name</mat-label>
            <input matInput formControlName="label" />
          </mat-form-field>
          <mat-form-field appearance="outline">
            <mat-label>Activity Key</mat-label>
            <input matInput formControlName="id" />
          </mat-form-field>
        </div>

        <div class="form__row">
          <mat-form-field appearance="outline">
            <mat-label>Activity-Type</mat-label>
            <input matInput formControlName="activityType" />
          </mat-form-field>
          <mat-form-field appearance="outline">
            <mat-label>Template (optional)</mat-label>
            <mat-select formControlName="templateId" (valueChange)="applyTemplateToActivity($event)">
              <mat-option [value]="null">Kein Template</mat-option>
              @for (template of templates(); track template.id) {
                <mat-option [value]="template.id">{{ template.label }}</mat-option>
              }
            </mat-select>
          </mat-form-field>
        </div>

        <div class="form__row">
          <mat-form-field appearance="outline">
            <mat-label>Default-Dauer (min)</mat-label>
            <input matInput type="number" formControlName="defaultDurationMinutes" />
          </mat-form-field>
          <mat-form-field appearance="outline">
            <mat-label>Relevant für</mat-label>
            <mat-select formControlName="relevantFor" multiple>
              <mat-option value="personnel">Personal</mat-option>
              <mat-option value="vehicle">Fahrzeug</mat-option>
              <mat-option value="personnel-service">Personaldienst</mat-option>
              <mat-option value="vehicle-service">Fahrzeugdienst</mat-option>
            </mat-select>
          </mat-form-field>
        </div>

        <div class="attributes">
          <div class="attributes__header">
            <span>Attribute</span>
            <mat-form-field appearance="outline" class="attributes__preset">
              <mat-label>Preset hinzufügen</mat-label>
              <mat-select (selectionChange)="addActivityAttributeFromPreset($event.value)" [value]="null">
                <mat-option [value]="null">Ohne</mat-option>
                @for (preset of attributePresets(); track preset.key) {
                  <mat-option [value]="preset.key">{{ preset.key }}</mat-option>
                }
              </mat-select>
            </mat-form-field>
              <button mat-stroked-button type="button" (click)="addActivityAttribute()">
                <mat-icon fontIcon="add"></mat-icon>
                Attribut
              </button>
            </div>
            <div class="attributes__list" formArrayName="attributes">
              @for (attr of activityAttributes.controls; track attr; let i = $index) {
              <div class="attributes__row" [formGroupName]="i">
                <mat-form-field appearance="outline">
                  <mat-label>Key</mat-label>
                  <input matInput formControlName="key" />
                </mat-form-field>
                <button mat-icon-button type="button" (click)="removeActivityAttribute(i)" matTooltip="Entfernen">
                  <mat-icon fontIcon="close"></mat-icon>
                </button>
                <div class="attributes__meta" formArrayName="meta">
                  <div class="attributes__meta-row" *ngFor="let meta of activityMetaControls(attr); let m = index" [formGroupName]="m">
                    <mat-form-field appearance="outline">
                      <mat-label>Meta-Key</mat-label>
                      <input matInput formControlName="key" />
                    </mat-form-field>
                    <mat-form-field appearance="outline">
                      <mat-label>Meta-Wert</mat-label>
                      <input matInput formControlName="value" />
                    </mat-form-field>
                    <button mat-icon-button type="button" (click)="removeActivityMeta(attr, m)" matTooltip="Meta entfernen">
                      <mat-icon fontIcon="close"></mat-icon>
                    </button>
                  </div>
                  <button mat-stroked-button type="button" (click)="addActivityMeta(attr)">
                    <mat-icon fontIcon="add"></mat-icon>
                    Meta
                  </button>
                </div>
              </div>
            }
            @if (activityAttributes.length === 0) {
              <p class="attributes__placeholder">Füge Key/Value-Paare hinzu oder wähle ein Template.</p>
            }
          </div>
        </div>

        <div class="form__actions">
          <button mat-button type="button" (click)="cancelActivityEdit()">
            Abbrechen
          </button>
          <button mat-flat-button color="primary" type="button" (click)="saveActivity()">
            {{ activityEditId() ? 'Speichern' : 'Anlegen' }}
          </button>
        </div>
      </form>

      <mat-divider class="panel__divider" />

      <div class="cards">
        @if (activities().length === 0) {
          <p class="cards__empty">Noch keine Activity Keys vorhanden.</p>
        } @else {
          @for (activity of activities(); track activity.id) {
            <mat-card class="card card--accent">
              <div class="card__heading">
                <div>
                  <p class="card__eyebrow">Activity</p>
                  <h4>{{ activity.label }}</h4>
                </div>
                <div class="card__actions">
                  <button mat-icon-button matTooltip="Bearbeiten" (click)="startActivityEdit(activity)">
                    <mat-icon fontIcon="edit"></mat-icon>
                  </button>
                  <button mat-icon-button matTooltip="Löschen" (click)="removeActivity(activity)">
                    <mat-icon fontIcon="delete"></mat-icon>
                  </button>
                </div>
              </div>
              <div class="card__meta">
                <span class="chip">Key: {{ activity.id }}</span>
                <span class="chip">Typ: {{ activity.activityType }}</span>
                <span class="chip" *ngIf="activity.templateId">Template: {{ activity.templateId }}</span>
                <span class="chip chip--ghost" *ngIf="activity.defaultDurationMinutes">
                  {{ activity.defaultDurationMinutes }} min
                </span>
              </div>
              <div class="card__attributes" *ngIf="activity.attributes.length">
                <mat-chip-listbox>
                  @for (attr of activity.attributes; track attr.key) {
                    <mat-chip>
                      <strong>{{ attr.key }}</strong>
                      <span *ngIf="attr.meta?.['value'] as val">Value: {{ val }}</span>
                      <span *ngIf="attr.meta && !attr.meta?.['value']">{{ attr.meta | json }}</span>
                    </mat-chip>
                  }
                </mat-chip-listbox>
              </div>
            </mat-card>
          }
        }
      </div>
    </mat-card>
  </div>
</section>
