<section class="planning-dashboard">
  <header class="planning-toolbar">
    <div class="planning-toolbar__row planning-toolbar__row--actions">
      <span class="planning-toolbar__summary">
        {{ boards().length }} Plantafel(n) · {{ resources().length }} Ressourcen ·
        {{ selectionSize() }} ausgewählt
      </span>

      <button
        mat-stroked-button
        color="primary"
        class="planning-toolbar__button"
        [matMenuTriggerFor]="resourceMenu"
      >
        Ressourcen wählen
      </button>

      <button mat-button class="planning-toolbar__button" (click)="selectAllResources()">
        Alle
      </button>

      <button
        mat-button
        class="planning-toolbar__button"
        [disabled]="selectionSize() === 0"
        (click)="clearSelection()"
      >
        Leeren
      </button>

      <button
        mat-flat-button
        color="primary"
        class="planning-toolbar__button"
        (click)="createBoardFromSelection()"
      >
        Plantafel aus Auswahl
      </button>

      <button
        mat-stroked-button
        class="planning-toolbar__button"
        [disabled]="!hasSelection()"
        [matMenuTriggerFor]="selectionAddMenu"
      >
        Auswahl hinzufügen
      </button>

      <button
        mat-stroked-button
        color="warn"
        class="planning-toolbar__button"
        [disabled]="!hasSelection()"
        [matMenuTriggerFor]="selectionReplaceMenu"
      >
        Plantafel ersetzen
      </button>

      <mat-button-toggle-group
        class="planning-toolbar__creation-toggle"
        [value]="activityCreationTool()"
        (change)="setActivityCreationTool($event.value)"
        name="creationMode"
        aria-label="Aktivitätstyp wählen"
      >
        <mat-button-toggle
          *ngFor="let option of activityCreationOptions(); trackBy: trackActivityType"
          [value]="option.id"
        >
          {{ option.label }}
        </mat-button-toggle>
      </mat-button-toggle-group>

      <button
        mat-icon-button
        class="planning-toolbar__info"
        matTooltip="Phasenbeschreibung anzeigen"
        [matMenuTriggerFor]="stageInfoMenu"
      >
        <mat-icon fontIcon="info"></mat-icon>
      </button>
    </div>
  </header>

  <mat-menu #stageInfoMenu="matMenu" class="planning-stage-info-menu" [overlapTrigger]="false">
    <ng-template matMenuContent>
      <ng-container *ngIf="activeStageMeta() as stageMeta">
        <div class="planning-stage-info">
          <h3>{{ stageMeta.label }}</h3>
          <p class="planning-stage-info__description">{{ stageMeta.description }}</p>
          <section>
            <h4>{{ stageMeta.focusHeadline }}</h4>
            <mat-chip-set>
              <mat-chip *ngFor="let focus of stageMeta.focusPoints; trackBy: trackFocus">
                {{ focus }}
              </mat-chip>
            </mat-chip-set>
          </section>
          <section>
            <h4>{{ stageMeta.contextHeadline }}</h4>
            <ul>
              <li *ngFor="let detail of stageMeta.contextDetails">{{ detail }}</li>
            </ul>
          </section>
        </div>
      </ng-container>
    </ng-template>
  </mat-menu>

  <mat-menu
    #resourceMenu="matMenu"
    class="planning-resource-menu"
    [hasBackdrop]="true"
    [overlapTrigger]="false"
  >
    <ng-template matMenuContent>
      <div class="planning-resource-menu__content">
        <div class="planning-resource-menu__actions">
          <button mat-stroked-button color="primary" (click)="selectAllResources()">
            Alle auswählen
          </button>
          <button mat-button (click)="clearSelection()">Auswahl leeren</button>
        </div>
        <div class="planning-resource-menu__groups">
          <section *ngFor="let group of resourceGroups()">
            <header class="planning-resource-menu__group-header">
              <mat-icon fontIcon="{{ group.icon }}"></mat-icon>
              <div>
                <span class="planning-resource-menu__group-label">{{ group.label }}</span>
                <span class="planning-resource-menu__group-meta">
                  {{ group.resources.length }} Ressourcen
                </span>
                <p>{{ group.description }}</p>
              </div>
            </header>
            <div class="planning-resource-menu__list">
              <mat-checkbox
                *ngFor="let resource of group.resources; trackBy: trackResource"
                [checked]="isResourceSelected(resource.id)"
                (change)="onSelectionToggle(resource.id, $event.checked)"
              >
                <span class="planning-resource-menu__resource-name">{{ resource.name }}</span>
                <span class="planning-resource-menu__resource-id">{{ resource.id }}</span>
              </mat-checkbox>
            </div>
          </section>
        </div>
      </div>
    </ng-template>
  </mat-menu>

  <mat-menu #selectionAddMenu="matMenu">
    <button
      mat-menu-item
      *ngFor="let board of boards(); trackBy: trackBoard"
      (click)="addSelectionToBoard(board.id)"
    >
      {{ board.title }}
    </button>
  </mat-menu>

  <mat-menu #selectionReplaceMenu="matMenu">
    <button
      mat-menu-item
      *ngFor="let board of boards(); trackBy: trackBoard"
      (click)="replaceBoardWithSelection(board.id)"
    >
      {{ board.title }}
    </button>
  </mat-menu>

  <section class="planning-main">
    <mat-card class="planning-main__card">
      <mat-card-content>
        <mat-tab-group
          class="planning-board-tabs"
          [selectedIndex]="selectedBoardIndex()"
          (selectedIndexChange)="handleBoardIndexChange($event)"
          animationDuration="250ms"
        >
          <mat-tab *ngFor="let board of boards(); trackBy: trackBoard">
            <ng-template mat-tab-label>
              <span [class.is-active]="isActiveBoard(board.id)">{{ board.title }}</span>
              <button
                *ngIf="boards().length > 1"
                mat-icon-button
                matTooltip="Plantafel schließen"
                (click)="removeBoard(board.id); $event.stopPropagation()"
              >
                <mat-icon fontIcon="close"></mat-icon>
              </button>
            </ng-template>

            <div class="planning-board">
              <header class="planning-board__header">
                <div class="planning-board__meta">
                  {{ board.resourceIds.length }} Ressourcen ·
                  {{ boardActivities(board).length }} Aktivitäten
                </div>
                <div class="planning-board__actions">
                  <button mat-button (click)="setSelectionFromBoard(board.id)">
                    Auswahl übernehmen
                  </button>
                  <button
                    mat-button
                    color="primary"
                    [disabled]="!hasSelection()"
                    (click)="addSelectionToBoard(board.id)"
                  >
                    Auswahl hinzufügen
                  </button>
                  <button
                    mat-button
                    color="warn"
                    [disabled]="!hasSelection()"
                    (click)="replaceBoardWithSelection(board.id)"
                  >
                    Ersetzen
                  </button>
                </div>
              </header>

              <div class="planning-board__gantt" *ngIf="board.resourceIds.length > 0; else emptyBoard">
                <app-gantt
                  [resources]="boardResources(board)"
                  [activities]="boardActivities(board)"
                  [timelineRange]="timelineRange()"
                  [resourceViewModes]="resourceViewModes()"
                  [selectedActivityIds]="selectedActivityIdsArray()"
                  (resourceViewModeChange)="handleResourceViewModeChange($event)"
                  (serviceAssignmentRequested)="handleServiceAssignRequest($event)"
                  (activityCreateRequested)="handleActivityCreate($event)"
                  (activityEditRequested)="handleActivityEdit($event)"
                  (activitySelectionToggle)="handleActivitySelectionToggle($event)"
                  (removeResource)="removeResourceFromBoard(board.id, $event)"
                />
              </div>

              <ng-template #emptyBoard>
                <div class="planning-board__empty">
                  <mat-icon fontIcon="dashboard"></mat-icon>
                  <p>Diese Plantafel enthält noch keine Ressourcen. Bitte Auswahl hinzufügen.</p>
                </div>
              </ng-template>
            </div>
          </mat-tab>
        </mat-tab-group>
      </mat-card-content>
    </mat-card>
  </section>

  <section class="planning-side-panels">
    <mat-card *ngIf="pendingServiceResource() as pending">
      <mat-card-header>
        <mat-card-title>Dienst zuweisen</mat-card-title>
        <mat-card-subtitle>{{ pending.name }}</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <p>Wähle eine Ressource aus, die diesen Dienst übernehmen soll.</p>
        <mat-form-field appearance="outline" class="planning-side-panels__field">
          <mat-label>Zielressource</mat-label>
          <mat-select
            [value]="serviceAssignmentTarget()"
            (selectionChange)="setServiceAssignmentTarget($event.value)"
          >
            <mat-option *ngFor="let candidate of assignmentCandidates()" [value]="candidate.id">
              {{ candidate.name }}
            </mat-option>
          </mat-select>
        </mat-form-field>
      </mat-card-content>
      <mat-card-actions align="end">
        <button mat-button type="button" (click)="cancelServiceAssignment()">Abbrechen</button>
        <button
          mat-flat-button
          color="primary"
          type="button"
          [disabled]="!serviceAssignmentTarget()"
          (click)="confirmServiceAssignment()"
        >
          Zuweisen
        </button>
      </mat-card-actions>
    </mat-card>

    <mat-card *ngIf="selectedActivities().length > 0">
      <mat-card-header>
        <mat-card-title>Auswahl ({{ selectedActivities().length }})</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <mat-chip-set class="planning-selection-chips">
          <mat-chip *ngFor="let item of selectedActivities(); trackBy: trackActivity">
            {{ item.activity.title }}
          </mat-chip>
        </mat-chip-set>

        <mat-form-field appearance="outline" class="planning-side-panels__field">
          <mat-label>Zielressource</mat-label>
          <mat-select
            [value]="activityMoveTarget()"
            (selectionChange)="setMoveSelectionTarget($event.value)"
            [disabled]="moveTargetOptions().length === 0"
          >
            <mat-option *ngFor="let resource of moveTargetOptions(); trackBy: trackResource" [value]="resource.id">
              {{ resource.name }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <div class="planning-side-panels__buttons">
          <button mat-stroked-button type="button" (click)="clearActivitySelection()">
            Auswahl leeren
          </button>
          <button
            mat-flat-button
            color="primary"
            type="button"
            (click)="moveSelectionToTarget()"
            [disabled]="!activityMoveTarget()"
          >
            Auf Ressource verschieben
          </button>
        </div>

        <div class="planning-side-panels__shift" *ngIf="selectedActivities().length === 1">
          <span>Horizontal verschieben:</span>
          <button mat-stroked-button type="button" (click)="shiftSelectedActivityBy(-30)">
            -30 min
          </button>
          <button mat-stroked-button type="button" (click)="shiftSelectedActivityBy(-5)">
            -5 min
          </button>
          <button mat-stroked-button type="button" (click)="shiftSelectedActivityBy(5)">
            +5 min
          </button>
          <button mat-stroked-button type="button" (click)="shiftSelectedActivityBy(30)">
            +30 min
          </button>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card *ngIf="selectedActivity() as selected">
      <mat-card-header>
        <mat-card-title>Aktivität bearbeiten</mat-card-title>
        <mat-card-subtitle>{{ selected.activity.title }}</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <form [formGroup]="activityForm" class="planning-side-panels__form" (ngSubmit)="saveSelectedActivityEdits()">
          <mat-form-field appearance="outline">
            <mat-label>Titel</mat-label>
            <input matInput formControlName="title" />
          </mat-form-field>
          <mat-form-field appearance="outline">
            <mat-label>Start</mat-label>
            <input matInput type="datetime-local" formControlName="start" />
          </mat-form-field>
          <mat-form-field appearance="outline">
            <mat-label>Ende</mat-label>
            <input matInput type="datetime-local" formControlName="end" />
          </mat-form-field>
          <mat-form-field appearance="outline">
            <mat-label>Typ</mat-label>
            <mat-select formControlName="type">
              <mat-option *ngFor="let option of activityCreationOptions(); trackBy: trackActivityType" [value]="option.id">
                {{ option.label }}
              </mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline" *ngIf="definitionHasField(selectedActivityDefinition(), 'from')">
            <mat-label>Von</mat-label>
            <input matInput formControlName="from" />
          </mat-form-field>

          <mat-form-field appearance="outline" *ngIf="definitionHasField(selectedActivityDefinition(), 'to')">
            <mat-label>Nach</mat-label>
            <input matInput formControlName="to" />
          </mat-form-field>

          <mat-form-field
            appearance="outline"
            class="planning-side-panels__full"
            *ngIf="definitionHasField(selectedActivityDefinition(), 'remark')"
          >
            <mat-label>Bemerkung</mat-label>
            <textarea matInput rows="2" formControlName="remark"></textarea>
          </mat-form-field>
        </form>
        <div class="planning-side-panels__buttons">
          <button mat-stroked-button type="button" (click)="addParticipantsToActiveBoard()">
            Teilnehmende Ressourcen hinzufügen
          </button>
          <button mat-stroked-button type="button" (click)="openBoardForParticipants()">
            Neue Plantafel mit Teilnehmern
          </button>
        </div>
      </mat-card-content>
      <mat-card-actions align="end">
        <button mat-button type="button" (click)="clearSelectedActivity()">Abbrechen</button>
        <button mat-button color="warn" type="button" (click)="deleteSelectedActivity()">
          Löschen
        </button>
        <button
          mat-flat-button
          color="primary"
          type="button"
          [disabled]="activityForm.pristine || activityForm.invalid"
          (click)="saveSelectedActivityEdits()"
        >
          Speichern
        </button>
      </mat-card-actions>
    </mat-card>
  </section>
</section>
