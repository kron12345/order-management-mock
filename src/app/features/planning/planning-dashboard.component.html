<section class="planning-dashboard">
  <header class="planning-toolbar">
    <div class="planning-toolbar__row planning-toolbar__row--actions">
      <span class="planning-toolbar__summary">
        {{ boards().length }} Plantafel(n) · {{ resources().length }} Ressourcen ·
        {{ selectionSize() }} ausgewählt
      </span>

      <div class="planning-filter-bar">
        <div class="planning-filter" tabindex="0">
          <button type="button" class="planning-filter__trigger">
            <mat-icon fontIcon="layers"></mat-icon>
            <span>{{ activeStageMeta().label }}</span>
          </button>
          <div class="planning-filter__panel">
            <div class="planning-filter__panel-title">Planungsphase</div>
            <div class="planning-filter__panel-list">
              @for (stage of stages; track stage.id) {
                <button
                  type="button"
                  class="planning-filter__option"
                  [class.is-active]="stage.id === activeStageId()"
                  (click)="onStageChange(stage.id)"
                >
                  <strong>{{ stage.label }}</strong>
                  <span>{{ stage.description }}</span>
                </button>
              }
            </div>
          </div>
        </div>

        <div class="planning-filter planning-filter--wide" tabindex="0">
          <button type="button" class="planning-filter__trigger">
            <mat-icon fontIcon="calendar_month"></mat-icon>
            <span>{{ timetableYearSummary() }}</span>
          </button>
          <div class="planning-filter__panel planning-filter__panel--wide">
            <div class="planning-filter__panel-title">Fahrplanjahre</div>
            <div class="planning-filter__panel-actions">
              <button mat-stroked-button type="button" (click)="selectDefaultTimetableYear()">
                Aktuelles
              </button>
              <button mat-button type="button" (click)="selectAllTimetableYears()">
                Alle
              </button>
            </div>
            <div class="planning-filter__panel-list planning-filter__panel-list--resources">
              @for (year of timetableYearOptions(); track year.label) {
                <mat-checkbox
                  [checked]="isTimetableYearSelected(year.label)"
                  (change)="onTimetableYearToggle(year.label, $event.checked)"
                >
                  {{ year.label }} · {{ year.startIso }} – {{ year.endIso }}
                </mat-checkbox>
              }
            </div>
          </div>
        </div>

        <div class="planning-filter planning-filter--wide" tabindex="0">
          <button type="button" class="planning-filter__trigger">
            <mat-icon fontIcon="group"></mat-icon>
            <span>Ressourcen</span>
          </button>
          <div class="planning-filter__panel planning-filter__panel--wide">
            <div class="planning-filter__panel-title">Ressourcen</div>
            <div class="planning-filter__panel-actions">
              <button mat-stroked-button (click)="selectAllResources()">Alle</button>
              <button mat-button (click)="clearSelection()">Leeren</button>
            </div>
            <div class="planning-filter__panel-groups">
              @for (group of resourceGroups(); track group.label) {
                <div class="planning-filter__panel-group">
                  <header>
                    <strong>{{ group.label }}</strong>
                    <small>{{ group.resources.length }} Ressourcen</small>
                  </header>
                  <div class="planning-filter__panel-list planning-filter__panel-list--resources">
                    @for (resource of group.resources; track resource.id) {
                      <mat-checkbox
                        [checked]="isResourceSelected(resource.id)"
                        (change)="onSelectionToggle(resource.id, $event.checked)"
                      >
                        {{ resource.name }}
                      </mat-checkbox>
                    }
                  </div>
                </div>
              }
            </div>
          </div>
        </div>

        <div class="planning-filter" tabindex="0">
          <button type="button" class="planning-filter__trigger">
            <mat-icon fontIcon="view_week"></mat-icon>
            <span>Leistungen</span>
          </button>
          <div class="planning-filter__panel">
            <div class="planning-filter__panel-title">Leistungstypen</div>
            <div class="planning-filter__tags">
              @for (definition of activityCreationOptions(); track definition.id) {
                <button type="button" (click)="selectActivityType(definition.id)">
                  {{ definition.label }}
                </button>
              }
            </div>
          </div>
        </div>
      </div>

      <div class="planning-toolbar__quick">
        <button
          mat-icon-button
          matTooltip="Plantafel aus Auswahl"
          (click)="createBoardFromSelection()"
        >
          <mat-icon fontIcon="library_add"></mat-icon>
        </button>
        <button
          mat-icon-button
          matTooltip="Auswahl hinzufügen"
          [disabled]="!hasSelection()"
          [matMenuTriggerFor]="selectionAddMenu"
        >
          <mat-icon fontIcon="playlist_add"></mat-icon>
        </button>
        <button
          mat-icon-button
          matTooltip="Plantafel ersetzen"
          [disabled]="!hasSelection()"
          [matMenuTriggerFor]="selectionReplaceMenu"
        >
          <mat-icon fontIcon="sync_alt"></mat-icon>
        </button>
      </div>
    </div>
    <div
      class="planning-toolbar__row planning-toolbar__row--base-toggle"
      *ngIf="activeStageId() === 'base'"
    >
      <button mat-stroked-button color="primary" (click)="toggleBasePlanningPanel()">
        <mat-icon fontIcon="view_week"></mat-icon>
        {{ isBasePlanningPanelOpen() ? 'Basisplanung schließen' : 'Basisplanung öffnen' }}
      </button>
      <span class="planning-toolbar__hint">
        Zeitscheiben bearbeiten, ohne dass der Gantt-Bereich kleiner wird.
      </span>
    </div>
  </header>

  <mat-menu #selectionAddMenu="matMenu">
    <button
      mat-menu-item
      *ngFor="let board of boards(); trackBy: trackBoard"
      (click)="addSelectionToBoard(board.id)"
    >
      {{ board.title }}
    </button>
  </mat-menu>

  <mat-menu #selectionReplaceMenu="matMenu">
    <button
      mat-menu-item
      *ngFor="let board of boards(); trackBy: trackBoard"
      (click)="replaceBoardWithSelection(board.id)"
    >
      {{ board.title }}
    </button>
  </mat-menu>

  <section class="planning-main">
    <mat-card class="planning-main__card">
      <mat-card-content>
        <mat-tab-group
          class="planning-board-tabs"
          [selectedIndex]="selectedBoardIndex()"
          (selectedIndexChange)="handleBoardIndexChange($event)"
          animationDuration="250ms"
        >
          <mat-tab *ngFor="let board of boards(); trackBy: trackBoard">
            <ng-template mat-tab-label>
              <span [class.is-active]="isActiveBoard(board.id)">{{ board.title }}</span>
              <button
                *ngIf="boards().length > 1"
                mat-icon-button
                matTooltip="Plantafel schließen"
                (click)="removeBoard(board.id); $event.stopPropagation()"
              >
                <mat-icon fontIcon="close"></mat-icon>
              </button>
            </ng-template>

            <div class="planning-board">
              <header class="planning-board__header">
                <div class="planning-board__meta">
                  {{ board.resourceIds.length }} Ressourcen ·
                  {{ boardActivities(board).length }} Aktivitäten
                </div>
                <div class="planning-board__actions">
                  <button mat-button (click)="setSelectionFromBoard(board.id)">
                    Auswahl übernehmen
                  </button>
                  <button
                    mat-button
                    color="primary"
                    [disabled]="!hasSelection()"
                    (click)="addSelectionToBoard(board.id)"
                  >
                    Auswahl hinzufügen
                  </button>
                  <button
                    mat-button
                    color="warn"
                    [disabled]="!hasSelection()"
                    (click)="replaceBoardWithSelection(board.id)"
                  >
                    Ersetzen
                  </button>
                  <app-gantt-window-launcher
                    [stageId]="activeStageId()"
                    [boardId]="board.id"
                    [resourceIds]="board.resourceIds"
                  />
                </div>
              </header>

              <div class="planning-board__gantt" *ngIf="board.resourceIds.length > 0; else emptyBoard">
                <app-gantt
                  [resources]="boardResources(board)"
                  [activities]="boardActivities(board)"
                  [pendingActivity]="boardPendingActivity(board)"
                  [timelineRange]="timelineRange()"
                  [minTimelineDays]="activeStageId() === 'base' ? 8 : 30"
                  [snapTimelineToMidnight]="activeStageId() !== 'base'"
                  [resourceViewModes]="resourceViewModes()"
                  [selectedActivityIds]="selectedActivityIdsArray()"
                  [activityTypeInfo]="activityTypeInfoMap()"
                  (resourceViewModeChange)="handleResourceViewModeChange($event)"
                  (serviceAssignmentRequested)="handleServiceAssignRequest($event)"
                  (activityCreateRequested)="handleActivityCreate($event)"
                  (activityEditRequested)="handleActivityEdit($event)"
                  (activityRepositionRequested)="handleActivityReposition($event)"
                  (activitySelectionToggle)="handleActivitySelectionToggle($event)"
                  (removeResource)="removeResourceFromBoard(board.id, $event)"
                />
              </div>

              <ng-template #emptyBoard>
                <div class="planning-board__empty">
                  <mat-icon fontIcon="dashboard"></mat-icon>
                  <p>Diese Plantafel enthält noch keine Ressourcen. Bitte Auswahl hinzufügen.</p>
                </div>
              </ng-template>
            </div>
          </mat-tab>
        </mat-tab-group>
      </mat-card-content>
    </mat-card>
  </section>

  <section class="planning-side-panels">
    <mat-card *ngIf="pendingServiceResource() as pending">
      <mat-card-header>
        <mat-card-title>Dienst zuweisen</mat-card-title>
        <mat-card-subtitle>{{ pending.name }}</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <p>Wähle eine Ressource aus, die diesen Dienst übernehmen soll.</p>
        <mat-form-field appearance="outline" class="planning-side-panels__field">
          <mat-label>Zielressource</mat-label>
          <mat-select
            [value]="serviceAssignmentTarget()"
            (selectionChange)="setServiceAssignmentTarget($event.value)"
          >
            <mat-option *ngFor="let candidate of assignmentCandidates()" [value]="candidate.id">
              {{ candidate.name }}
            </mat-option>
          </mat-select>
        </mat-form-field>
      </mat-card-content>
      <mat-card-actions align="end">
        <button mat-button type="button" (click)="cancelServiceAssignment()">Abbrechen</button>
        <button
          mat-flat-button
          color="primary"
          type="button"
          [disabled]="!serviceAssignmentTarget()"
          (click)="confirmServiceAssignment()"
        >
          Zuweisen
        </button>
      </mat-card-actions>
    </mat-card>

    <div class="planning-panel" *ngIf="selectedActivities().length > 0" cdkDrag>
      <div class="planning-panel__header" cdkDragHandle>
        <div>
          <div class="planning-panel__title">Auswahl</div>
          <div class="planning-panel__subtitle">{{ selectedActivities().length }} Aktivität(en)</div>
        </div>
        <button mat-icon-button type="button" (click)="clearActivitySelection()" aria-label="Auswahl leeren">
          <mat-icon fontIcon="close"></mat-icon>
        </button>
      </div>
      <div class="planning-panel__body">
        <mat-chip-set class="planning-selection-chips">
          <mat-chip *ngFor="let item of selectedActivities(); trackBy: trackActivity">
            {{ activityTypeLabel(item.activity.type) }}
          </mat-chip>
        </mat-chip-set>

        <mat-form-field appearance="outline" class="planning-side-panels__field">
          <mat-label>Zielressource</mat-label>
          <mat-select
            [value]="activityMoveTarget()"
            (selectionChange)="setMoveSelectionTarget($event.value)"
            [disabled]="moveTargetOptions().length === 0"
          >
            <mat-option *ngFor="let resource of moveTargetOptions(); trackBy: trackResource" [value]="resource.id">
              {{ resource.name }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <div class="planning-side-panels__buttons">
          <button mat-stroked-button type="button" (click)="clearActivitySelection()">
            Auswahl leeren
          </button>
          <button
            mat-flat-button
            color="primary"
            type="button"
            (click)="moveSelectionToTarget()"
            [disabled]="!activityMoveTarget()"
          >
            Auf Ressource verschieben
          </button>
        </div>

      </div>
    </div>

    <div class="planning-panel planning-panel--form" *ngIf="selectedActivity() as selected" cdkDrag>
      <div class="planning-panel__header" cdkDragHandle>
        <div>
          <div class="planning-panel__title">
            {{ isSelectedActivityPending() ? 'Aktivität anlegen' : 'Aktivität bearbeiten' }}
          </div>
          <div class="planning-panel__subtitle">
            {{ activityTypeLabel(selected.activity.type) }}
            <span class="planning-panel__badge" *ngIf="isSelectedActivityPending()">Entwurf</span>
          </div>
        </div>
        <button mat-icon-button type="button" (click)="clearSelectedActivity()" aria-label="Panel schließen">
          <mat-icon fontIcon="close"></mat-icon>
        </button>
      </div>
      <div class="planning-panel__body">
        <form [formGroup]="activityForm" class="planning-side-panels__form" (ngSubmit)="saveSelectedActivityEdits()">
          <input type="hidden" formControlName="type" />

          <div class="planning-type-editor">
            <div class="planning-type-editor__type">
              @if (activeTypePickerGroup(); as activeGroup) {
                <div class="planning-type-picker">
                  <div class="planning-type-picker__header">
                    <span class="planning-type-picker__title">Typ</span>
                    <span class="planning-type-picker__current">
                      {{ selectedActivityDefinition()?.label ?? 'Bitte wählen' }}
                    </span>
                  </div>
                  <div class="planning-type-picker__tabs" *ngIf="activityTypePickerGroups().length > 1">
                    <button
                      type="button"
                      class="planning-type-picker__tab"
                      *ngFor="let group of activityTypePickerGroups()"
                      [class.is-active]="group.id === activeGroup.id"
                      (click)="setActivityTypePickerGroup(group.id)"
                    >
                      <mat-icon [fontIcon]="group.icon"></mat-icon>
                      <span>{{ group.label }}</span>
                      <small>{{ group.items.length }}</small>
                    </button>
                  </div>
                  <div class="planning-type-picker__list" role="listbox" aria-label="Aktivitätstyp auswählen">
                    <button
                      type="button"
                      class="planning-type-picker__list-item"
                      *ngFor="let definition of activeGroup.items; trackBy: trackActivityType"
                      [class.is-selected]="isActivityTypeSelected(definition.id)"
                      (click)="selectActivityType(definition.id)"
                    >
                      <span class="planning-type-picker__option-title">{{ definition.label }}</span>
                      <span class="planning-type-picker__option-description">
                        {{ definition.description ?? 'Ohne Beschreibung' }}
                      </span>
                    </button>
                  </div>
                </div>
              } @else {
                <ng-container *ngTemplateOutlet="fallbackTypeSelect"></ng-container>
              }
            </div>

            <div class="planning-type-editor__fields">
              <div class="planning-attribute-grid">
                <mat-form-field appearance="outline" class="planning-attribute-grid__item">
                  <mat-label>Start</mat-label>
                  <input matInput type="datetime-local" formControlName="start" />
                  <mat-error
                    *ngIf="
                      activityForm.controls.start.invalid &&
                      (activityForm.controls.start.dirty || activityForm.controls.start.touched)
                    "
                  >
                    Startzeit ist erforderlich.
                  </mat-error>
                </mat-form-field>
                <mat-form-field
                  appearance="outline"
                  class="planning-attribute-grid__item"
                  *ngIf="shouldShowEndField(selectedActivityDefinition())"
                >
                  <mat-label>Ende</mat-label>
                  <input matInput type="datetime-local" formControlName="end" />
                </mat-form-field>
                <mat-form-field
                  appearance="outline"
                  class="planning-attribute-grid__item"
                  *ngIf="definitionHasField(selectedActivityDefinition(), 'from')"
                >
                  <mat-label>Von</mat-label>
                  <input matInput formControlName="from" />
                </mat-form-field>
                <mat-form-field
                  appearance="outline"
                  class="planning-attribute-grid__item"
                  *ngIf="definitionHasField(selectedActivityDefinition(), 'to')"
                >
                  <mat-label>Nach</mat-label>
                  <input matInput formControlName="to" />
                </mat-form-field>
              </div>

              <div class="planning-attribute-grid__duration" *ngIf="activityForm.value.start && activityForm.value.end">
                Dauer:
                <span class="planning-attribute-grid__duration-value">
                  {{ activityForm.value.start | duration : activityForm.value.end }}
                </span>
                <span class="planning-attribute-grid__duration-actions">
                  <button mat-stroked-button type="button" (click)="adjustFormEndBy(-30)">-30</button>
                  <button mat-stroked-button type="button" (click)="adjustFormEndBy(-15)">-15</button>
                  <button mat-stroked-button type="button" (click)="adjustFormEndBy(15)">+15</button>
                  <button mat-stroked-button type="button" (click)="adjustFormEndBy(30)">+30</button>
                </span>
              </div>

              <div class="planning-time-tools">
                <div class="planning-time-tools__row">
                  <span>Horizontal:</span>
                  <button mat-stroked-button type="button" (click)="shiftFormBy(-30)">-30</button>
                  <button mat-stroked-button type="button" (click)="shiftFormBy(-5)">-5</button>
                  <button mat-stroked-button type="button" (click)="shiftFormBy(5)">+5</button>
                  <button mat-stroked-button type="button" (click)="shiftFormBy(30)">+30</button>
                </div>
                <div class="planning-time-tools__row">
                  <span>Andocken:</span>
                  <button mat-stroked-button type="button" (click)="snapFormToPrevious()">« Vorherige</button>
                  <button mat-stroked-button type="button" (click)="snapFormToNext()">Nächste »</button>
                  <button mat-stroked-button type="button" (click)="fillGapForForm()">Lücke</button>
                </div>
              </div>

              <mat-form-field
                appearance="outline"
                class="planning-type-editor__remark"
                *ngIf="definitionHasField(selectedActivityDefinition(), 'remark')"
              >
                <mat-label>Bemerkung</mat-label>
                <textarea matInput rows="2" formControlName="remark"></textarea>
              </mat-form-field>
            </div>
          </div>

          <ng-template #fallbackTypeSelect>
            <mat-form-field appearance="outline" class="planning-type-editor__fallback">
              <mat-label>Typ</mat-label>
              <mat-select formControlName="type">
                <mat-option *ngFor="let option of activityCreationOptions(); trackBy: trackActivityType" [value]="option.id">
                  {{ option.label }}
                </mat-option>
              </mat-select>
            </mat-form-field>
          </ng-template>
        </form>
        <div class="planning-side-panels__buttons">
          <button mat-stroked-button type="button" (click)="addParticipantsToActiveBoard()">
            Teilnehmende Ressourcen hinzufügen
          </button>
          <button mat-stroked-button type="button" (click)="openBoardForParticipants()">
            Neue Plantafel mit Teilnehmern
          </button>
        </div>

        <div class="planning-panel__actions">
          <button
            mat-button
            type="button"
            *ngIf="isSelectedActivityPending()"
            (click)="resetPendingActivityEdits()"
          >
            Rückgängig
          </button>
          <button mat-button type="button" (click)="clearSelectedActivity()">
            {{ isSelectedActivityPending() ? 'Panel schließen' : 'Abbrechen' }}
          </button>
          <button mat-button color="warn" type="button" (click)="deleteSelectedActivity()">
            Löschen
          </button>
          <button
            mat-flat-button
            color="primary"
            type="submit"
            [disabled]="activityForm.invalid || (!isSelectedActivityPending() && activityForm.pristine)"
          >
            {{ isSelectedActivityPending() ? 'Anlegen' : 'Speichern' }}
          </button>
        </div>
      </div>
    </div>
  </section>

  <div
    class="planning-base-overlay"
    *ngIf="isBasePlanningPanelOpen() && activeStageId() === 'base'"
  >
    <div class="planning-base-overlay__backdrop" (click)="closeBasePlanningPanel()"></div>
    <section class="planning-base-overlay__panel">
      <header class="planning-base-overlay__header">
        <div>
          <div class="planning-base-overlay__title">Planwochen & Zeitscheiben</div>
          <div class="planning-base-overlay__subtitle">
            Vorlagen pflegen, Gültigkeiten definieren und Rollouts starten.
          </div>
        </div>
        <button
          mat-icon-button
          type="button"
          aria-label="Basisplanung schließen"
          (click)="closeBasePlanningPanel()"
        >
          <mat-icon fontIcon="close"></mat-icon>
        </button>
      </header>
      <div class="planning-base-overlay__content">
        <app-plan-week-template [timetableYearRange]="basePlanningYearRange()"></app-plan-week-template>
      </div>
    </section>
  </div>
</section>
