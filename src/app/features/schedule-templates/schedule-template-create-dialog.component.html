<h2 mat-dialog-title>Neue Fahrplanvorlage</h2>

<mat-dialog-content class="dialog-content">
  <form class="template-form" [formGroup]="form">
    <section class="section">
      <h3>Stammdaten</h3>
      <div class="grid grid--two">
        <mat-form-field appearance="outline">
          <mat-label>Titel</mat-label>
          <input matInput formControlName="title" placeholder="z. B. S3 Basel → Olten" />
          @if (form.controls.title.invalid && form.controls.title.touched) {
            <mat-error>Titel ist erforderlich.</mat-error>
          }
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Zugnummer / OTN</mat-label>
          <input matInput formControlName="trainNumber" placeholder="z. B. S3" />
          @if (
            form.controls.trainNumber.invalid && form.controls.trainNumber.touched
          ) {
            <mat-error>Zugnummer ist erforderlich.</mat-error>
          }
        </mat-form-field>
      </div>

      <mat-form-field appearance="outline">
        <mat-label>Beschreibung</mat-label>
        <textarea
          matInput
          formControlName="description"
          rows="3"
          placeholder="Worum geht es bei dieser Vorlage?"
        ></textarea>
      </mat-form-field>

      <div class="grid grid--three">
        <mat-form-field appearance="outline">
          <mat-label>Verantwortliche RU</mat-label>
          <input matInput formControlName="responsibleRu" placeholder="z. B. Qnamic Rail GmbH" />
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Status</mat-label>
          <mat-select formControlName="status">
            @for (option of statusOptions; track option) {
              <mat-option [value]="option">{{ option | titlecase }}</mat-option>
            }
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Kategorie</mat-label>
          <mat-select formControlName="category">
            @for (option of categoryOptions; track option) {
              <mat-option [value]="option">{{ option }}</mat-option>
            }
          </mat-select>
        </mat-form-field>
      </div>

      <div class="grid grid--two">
        <mat-form-field appearance="outline">
          <mat-label>Gültig ab</mat-label>
          <input matInput [matDatepicker]="startPicker" formControlName="startDate" />
          <mat-datepicker-toggle matIconSuffix [for]="startPicker" />
          <mat-datepicker #startPicker></mat-datepicker>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Gültig bis (optional)</mat-label>
          <input matInput [matDatepicker]="endPicker" formControlName="endDate" />
          <mat-datepicker-toggle matIconSuffix [for]="endPicker" />
          <mat-datepicker #endPicker></mat-datepicker>
        </mat-form-field>
      </div>

      <mat-form-field appearance="outline">
        <mat-label>Tags (kommagetrennt)</mat-label>
        <input matInput formControlName="tags" placeholder="S-Bahn, Basel, Nachtverkehr" />
      </mat-form-field>
    </section>

    <section class="section">
      <header>
        <h3>Rollout-Einstellungen</h3>
        <mat-slide-toggle formControlName="recurrenceEnabled">
          Serienfahrten aktiv
        </mat-slide-toggle>
      </header>

      <div class="grid grid--three" [class.disabled]="!form.value.recurrenceEnabled">
        <mat-form-field appearance="outline">
          <mat-label>Startzeit</mat-label>
          <input matInput formControlName="recurrenceStart" placeholder="HH:MM" />
        </mat-form-field>
        <mat-form-field appearance="outline">
          <mat-label>Endzeit</mat-label>
          <input matInput formControlName="recurrenceEnd" placeholder="HH:MM" />
        </mat-form-field>
        <mat-form-field appearance="outline">
          <mat-label>Intervall (Minuten)</mat-label>
          <input
            matInput
            type="number"
            min="1"
            max="720"
            formControlName="recurrenceInterval"
          />
        </mat-form-field>
      </div>

      <div class="day-toggle" [class.disabled]="!form.value.recurrenceEnabled">
        @for (day of dayOptions; track day.value) {
          <button
            type="button"
            mat-stroked-button
            [class.active]="form.controls.recurrenceDays.value.includes(day.value)"
            (click)="toggleRecurrenceDay(day.value)"
          >
            {{ day.label }}
          </button>
        }
      </div>
    </section>

    <section class="section">
      <div class="stops-header">
        <div>
          <h3>Fahrweg & Halte</h3>
          <p class="stops-hint">Bearbeite Halte, Zeiten und Aktivitäten im Dialog „Fahrplan zusammenstellen“.</p>
        </div>
        <button mat-stroked-button type="button" (click)="openPlanAssembly()">
          <mat-icon>build</mat-icon>
          Fahrplan zusammenstellen
        </button>
      </div>

      <div class="stop-summary">
        <div class="stop-summary__metrics">
          <span>Anzahl Halte: {{ stopCount() }}</span>
          <span>Start: {{ startStopLabel() }}</span>
          <span>Ziel: {{ endStopLabel() }}</span>
        </div>

        <div class="stop-summary__list" *ngIf="stopPreview().length; else noStopSummary">
          @for (stop of stopPreview(); track stop.sequence) {
            <div class="stop-summary__item">
              <span class="stop-summary__index">#{{ stop.sequence }}</span>
              <div class="stop-summary__content">
                <span class="stop-summary__name">{{ stop.name }}</span>
                @if (stop.time) {
                  <span class="stop-summary__time">{{ stop.time }}</span>
                }
              </div>
              <mat-chip color="primary" selected>{{ stop.type | titlecase }}</mat-chip>
            </div>
          }
        </div>

        <ng-template #noStopSummary>
          <p class="hint">Noch keine Halte definiert.</p>
        </ng-template>
      </div>
    </section>
  </form>
</mat-dialog-content>

<mat-dialog-actions align="end" class="dialog-actions">
  <button mat-button (click)="cancel()">Abbrechen</button>
  <button mat-flat-button color="primary" (click)="save()">Vorlage speichern</button>
</mat-dialog-actions>
