<div class="timetable-hub">
  <aside class="timetable-hub__list">
    <mat-form-field appearance="outline" class="timetable-hub__search">
      <mat-label>RefTrainID oder Zugnummer</mat-label>
      <input matInput [formControl]="searchControl" placeholder="z. B. TT-2030-ICE-001A" />
      @if (searchControl.value) {
        <button mat-icon-button matSuffix type="button" (click)="clearSearch()" aria-label="Suche löschen">
          <mat-icon>close</mat-icon>
        </button>
      }
    </mat-form-field>
    <div class="timetable-hub__list-items">
      @for (record of filteredRecords(); track trackRecord($index, record)) {
        <button
          type="button"
          class="timetable-hub__list-item"
          [class.timetable-hub__list-item--active]="activeRecord()?.refTrainId === record.refTrainId"
          (click)="selectRecord(record)"
        >
          <div class="list-item__title">{{ record.trainNumber }} · {{ record.title }}</div>
          <div class="list-item__subtitle">
            Ref {{ record.refTrainId }} · Jahr {{ record.timetableYearLabel }}
          </div>
        </button>
      }
      @if (!filteredRecords().length) {
        <p class="hint">Keine Züge gefunden.</p>
      }
    </div>
  </aside>

  <section class="timetable-hub__detail">
    <mat-card class="creation-card creation-card--dialog">
      <mat-card-title>Schnellzug erzeugen</mat-card-title>
      <mat-card-content>
        <p>
          Öffne den Dialog, um Fahrplanjahr, Kalender und Halte strukturiert zu erfassen. Die Oberfläche führt dich
          Schritt für Schritt durch Allgemeindaten, Stopps, Technik und Grenzpunkte.
        </p>
        <ul>
          <li>Halte komfortabel als Liste mit Ankunft/Abfahrt bearbeiten.</li>
          <li>Technische Daten & Grenzpunkte optional ergänzen.</li>
          <li>RefTrainID wird automatisch generiert und im Hub angezeigt.</li>
        </ul>
      </mat-card-content>
      <mat-card-actions>
        <button mat-flat-button color="primary" type="button" (click)="openCreationDialog()">
          <mat-icon>playlist_add</mat-icon>
          Dialog öffnen
        </button>
      </mat-card-actions>
    </mat-card>

    @if (activeRecord(); as record) {
      <header class="timetable-hub__header">
        <div>
          <h2>{{ record.title }}</h2>
          <p class="subtitle">Ref {{ record.refTrainId }} · Zug {{ record.trainNumber }}</p>
        </div>
        <mat-chip-set>
          <mat-chip color="primary" selected>{{ record.timetableYearLabel }}</mat-chip>
          <mat-chip appearance="outlined">Kalender: {{ record.calendarRangeLabel }}</mat-chip>
        </mat-chip-set>
      </header>

      <mat-card class="calendar-card">
        <mat-card-title>Kalender & Fahrtage</mat-card-title>
        <mat-card-subtitle>Bitmap {{ record.calendarBitmap }}</mat-card-subtitle>
        <div class="calendar-chip-row">
          <mat-chip-set>
            @for (day of calendarPreview(record); track day) {
              <mat-chip>{{ day }}</mat-chip>
            }
            @if (calendarOverflow(record) > 0) {
              <mat-chip class="muted-chip">+{{ calendarOverflow(record) }} weitere</mat-chip>
            }
          </mat-chip-set>
          <p class="calendar-hint">
            Fahrtage gelten für das Fahrplanjahr {{ record.timetableYearLabel }}. Anpassungen erfolgen über
            Unterkalender im Auftragsmanager.
          </p>
        </div>
      </mat-card>

      <div class="info-cards">
        <mat-card class="tech-card">
          <mat-card-title>Technische Parameter</mat-card-title>
          @if (hasTechnicalData(record)) {
            <div class="info-grid">
              <div class="info-stat">
                <span class="info-stat__label">Zugtyp</span>
                <strong>{{ textValue(record.technical?.trainType) }}</strong>
              </div>
              <div class="info-stat">
                <span class="info-stat__label">Höchstgeschwindigkeit</span>
                <strong>{{ technicalValue(record.technical?.maxSpeed, 'km/h') }}</strong>
              </div>
              <div class="info-stat">
                <span class="info-stat__label">Länge</span>
                <strong>{{ technicalValue(record.technical?.lengthMeters, 'm') }}</strong>
              </div>
              <div class="info-stat">
                <span class="info-stat__label">Gewicht</span>
                <strong>{{ technicalValue(record.technical?.weightTons, 't') }}</strong>
              </div>
              <div class="info-stat">
                <span class="info-stat__label">Traktion</span>
                <strong>{{ textValue(record.technical?.traction) }}</strong>
              </div>
              <div class="info-stat">
                <span class="info-stat__label">ETCS-Level</span>
                <strong>{{ textValue(record.technical?.etcsLevel) }}</strong>
              </div>
            </div>
          } @else {
            <p class="hint">Keine technischen Angaben hinterlegt.</p>
          }
        </mat-card>

        <mat-card class="route-card">
          <mat-card-title>Grenzpunkte & Strecke</mat-card-title>
          @if (hasRouteMetadata(record)) {
            <div class="info-grid info-grid--route">
              <div class="info-stat">
                <span class="info-stat__label">Start-Grenzpunkt</span>
                <strong>{{ routePointLabel(record.routeMetadata, 'originBorderPoint') }}</strong>
              </div>
              <div class="info-stat">
                <span class="info-stat__label">Ziel-Grenzpunkt</span>
                <strong>{{ routePointLabel(record.routeMetadata, 'destinationBorderPoint') }}</strong>
              </div>
            </div>
            <div class="route-notes-display">
              <span class="info-stat__label">Hinweise</span>
              <p>{{ routeNotes(record.routeMetadata) }}</p>
            </div>
          } @else {
            <p class="hint">Keine Grenzpunkte definiert.</p>
          }
        </mat-card>
      </div>

      <div class="section-tabs">
        @for (tab of sectionTabs; track tab.key) {
          <button
            mat-stroked-button
            type="button"
            [color]="activeSection() === tab.key ? 'primary' : undefined"
            [class.active]="activeSection() === tab.key"
            (click)="selectSection(tab.key)"
          >
            {{ tab.label }}
          </button>
        }
      </div>

      @if (activeSectionData(); as section) {
        <mat-card class="plan-card">
          <mat-card-title>{{ section.label }}</mat-card-title>
          <p class="plan-description">{{ section.description }}</p>
          @if (section.stops.length) {
              <div class="stop-table">
                <div class="stop-table__header">
                  <span>#</span>
                  <span>Ort</span>
                  <span>Typ</span>
                  <span>Zeit</span>
                  <span>Haltegrund</span>
                  <span>Verantwortliche EVU</span>
                  <span>Fahrzeuge</span>
                </div>
                @for (stop of section.stops; track stop.sequence) {
                  <div class="stop-table__row">
                    <span>#{{ stop.sequence }}</span>
                    <span>{{ stop.locationName }}</span>
                    <span>{{ stop.type | titlecase }}</span>
                    <span>{{ stopTimeLabel(stop) }}</span>
                    <span>{{ stop.holdReason }}</span>
                    <span>{{ stop.responsibleRu }}</span>
                    <span>{{ stop.vehicleInfo }}</span>
                  </div>
                }
              </div>
          } @else {
            <p class="hint">Keine Daten vorhanden.</p>
          }
        </mat-card>
      }

      <mat-card class="vehicles-card">
        <mat-card-title>Fahrzeuge (TTT-relevant)</mat-card-title>
        @let segments = record.vehicles?.segments ?? [];
        @if (segments.length) {
          <div class="vehicle-grid">
            @for (segment of segments; track $index) {
              <div class="vehicle-row">
                <div>
                  <strong>Segment #{{ segment.position }}</strong>
                  <span>{{ segment.count }} × {{ segment.vehicleTypeId }}</span>
                </div>
                <small *ngIf="segment.remarks">{{ segment.remarks }}</small>
              </div>
            }
          </div>
        } @else {
          <p class="hint">Keine Fahrzeugdaten hinterlegt.</p>
        }
      </mat-card>
    } @else {
      <div class="empty-state">
        <mat-icon>train</mat-icon>
        <p>Kein Zug ausgewählt.</p>
      </div>
    }
  </section>
</div>
